# 非機能要件一覧

## 概要
TaskFlowシステムの非機能要件を整理します。
中小規模チーム（5-50人）を対象とした、実用的かつ運用可能なシステムを目指します。

---

## 1. パフォーマンス要件

### 1.1 レスポンスタイム
| エンドポイント種別 | 目標レスポンスタイム | 最大許容時間 | 備考 |
|-------------------|---------------------|--------------|------|
| 認証（ログイン） | 300ms以内 | 500ms | パスワードハッシュ検証含む |
| 一覧取得（100件） | 200ms以内 | 500ms | ページネーション適用時 |
| 詳細取得 | 100ms以内 | 300ms | 関連データのJOIN含む |
| 作成・更新 | 200ms以内 | 500ms | バリデーション含む |
| 削除 | 150ms以内 | 300ms | CASCADE削除含む |
| 検索（全文検索） | 500ms以内 | 1000ms | PostgreSQL full-text search |

**測定条件**:
- データベース: 10,000タスク、100プロジェクト、50ユーザー
- ネットワーク遅延: 除外（サーバー内部処理時間のみ）
- 負荷: 同時接続50ユーザー

### 1.2 スループット
- **同時接続数**: 50ユーザーまで対応
- **リクエスト処理能力**: 100 req/sec（通常運用）
- **ピーク時処理能力**: 200 req/sec（短時間のバースト）

### 1.3 データベースパフォーマンス
- **クエリ実行時間**: 95%のクエリが100ms以内
- **インデックス戦略**:
  - 主キー（id）: デフォルト
  - 外部キー: すべてインデックス化
  - 検索フィールド: email, status, created_at
- **接続プール**: 最大25接続（PostgreSQL）

---

## 2. セキュリティ要件

### 2.1 認証・認可
| 項目 | 要件 | 実装方法 |
|------|------|----------|
| 認証方式 | JWT（JSON Web Token） | HMAC-SHA256署名 |
| トークン有効期限 | 24時間 | exp claimで管理 |
| パスワードハッシュ | bcrypt（cost=10以上） | golang.org/x/crypto/bcrypt |
| 最小パスワード長 | 8文字以上 | 登録時・変更時にバリデーション |
| HTTPS必須 | 本番環境では必須 | TLS 1.2以上 |
| CORS設定 | 許可オリジンのみ | 本番では厳格に制限 |

### 2.2 入力検証
- **すべてのエンドポイントで入力検証を実施**
- **バリデーションエラーは詳細を返す**（ただし、セキュリティに影響する情報は除外）
- **SQL injection対策**: prepared statement使用
- **XSS対策**: 出力時にエスケープ（フロントエンド側で実施）
- **CSRF対策**: API設計のため不要（ステートレスJWT認証）

### 2.3 データ保護
| 項目 | 要件 | 実装方法 |
|------|------|----------|
| パスワード保存 | 平文保存禁止 | bcryptハッシュのみ保存 |
| トークン保存 | サーバー側で保存しない | ステートレスJWT |
| 機密データログ | ログ出力禁止 | password, tokenはログから除外 |
| データベース暗号化 | Phase 3で検討 | PostgreSQL TDE |
| バックアップ暗号化 | Phase 3で検討 | 暗号化されたストレージに保存 |

### 2.4 権限管理
- **プロジェクト単位のアクセス制御**: メンバーのみアクセス可能
- **ロールベースアクセス制御（RBAC）**:
  - Owner: すべての操作可能
  - Member: 閲覧・タスク作成・自分のタスク編集
  - Viewer: 閲覧のみ
- **リソース単位の権限チェック**: ハンドラーで実施

---

## 3. 運用要件

### 3.1 ログ要件
| ログ種別 | 出力内容 | ログレベル | 保存期間 |
|----------|----------|------------|----------|
| アクセスログ | HTTPメソッド、パス、ステータスコード、実行時間、user_id | INFO | 30日 |
| エラーログ | エラー内容、スタックトレース、リクエスト情報 | ERROR | 90日 |
| 認証ログ | ログイン成功/失敗、user_id、IPアドレス | INFO/WARN | 90日 |
| 操作ログ | リソース作成/更新/削除、user_id、タイムスタンプ | INFO | 30日 |
| システムログ | アプリケーション起動/停止、設定変更 | INFO | 90日 |

**ログ形式**: JSON形式（構造化ログ）
**ログライブラリ**: `go.uber.org/zap` または `github.com/rs/zerolog`

### 3.2 監視・メトリクス
**Phase 1（MVP）**:
- アプリケーションヘルスチェックエンドポイント（`/health`）
- データベース接続確認

**Phase 2以降**:
- レスポンスタイム監視（P50, P95, P99）
- エラーレート監視
- CPU・メモリ使用率
- データベース接続プール使用状況
- ディスク使用量

**監視ツール候補**: Prometheus + Grafana

### 3.3 バックアップ
| 項目 | 要件 |
|------|------|
| データベースバックアップ | 毎日1回（深夜） |
| バックアップ保持期間 | 7日間 |
| リストア手順 | ドキュメント化（Phase 2） |
| バックアップテスト | 月1回実施（Phase 3） |

### 3.4 デプロイ
- **デプロイ方式**: Blue-Green デプロイまたはローリングアップデート（Phase 2以降）
- **ダウンタイム**: 計画メンテナンス時は事前通知（Phase 3）
- **ロールバック**: 前バージョンへの即座の切り戻し可能（Phase 2以降）

---

## 4. スケーラビリティ要件

### 4.1 データ量
| リソース | MVP目標 | Phase 2目標 | Phase 3目標 |
|----------|---------|-------------|-------------|
| ユーザー数 | 50人 | 200人 | 1,000人 |
| プロジェクト数 | 100個 | 500個 | 2,000個 |
| タスク数 | 10,000個 | 50,000個 | 200,000個 |
| コメント数 | 5,000個 | 20,000個 | 100,000個 |

### 4.2 水平スケーリング
**Phase 1（MVP）**:
- 単一サーバー構成
- 垂直スケーリング（スペック向上）で対応

**Phase 2以降**:
- アプリケーションサーバーの水平スケーリング対応
- ロードバランサー導入
- データベースのレプリケーション（Read Replica）

### 4.3 キャッシュ戦略
**Phase 1**: キャッシュなし（シンプル化優先）

**Phase 2以降**:
- プロジェクト一覧: 5分キャッシュ
- ユーザープロフィール: 10分キャッシュ
- キャッシュ実装: Redis

---

## 5. 可用性・信頼性

### 5.1 可用性目標
| Phase | 目標稼働率 | 許容ダウンタイム（月間） |
|-------|-----------|------------------------|
| Phase 1（MVP） | 95% | 36時間 |
| Phase 2 | 99% | 7.2時間 |
| Phase 3 | 99.5% | 3.6時間 |

**計画メンテナンス時間**: 除外

### 5.2 障害復旧
- **RPO（Recovery Point Objective）**: 24時間以内（Phase 1）、1時間以内（Phase 2以降）
- **RTO（Recovery Time Objective）**: 4時間以内（Phase 1）、1時間以内（Phase 2以降）

### 5.3 エラーハンドリング
- **すべてのエラーは統一フォーマットで返す**（API_FLOW.mdを参照）
- **500エラー時はログ記録 + 汎用エラーメッセージを返す**（内部エラー詳細は隠蔽）
- **リトライ可能なエラーは適切なHTTPステータスコードで返す**（429, 503など）

---

## 6. 保守性

### 6.1 コード品質
| 項目 | 目標値 | 測定方法 |
|------|--------|----------|
| テストカバレッジ | 80%以上 | `go test -cover` |
| Lintエラー | 0件 | `golangci-lint` |
| 循環的複雑度 | 15以下 | `gocyclo` |
| コードレビュー | 100%実施 | Pull Request |

### 6.2 ドキュメント
- **API仕様書**: OpenAPI 3.0形式（Phase 2で作成）
- **README.md**: セットアップ手順、開発環境構築
- **アーキテクチャドキュメント**: レイヤー構造、依存関係
- **運用手順書**: デプロイ、障害対応（Phase 2以降）

### 6.3 依存関係管理
- **Go modules**: `go.mod`でバージョン固定
- **脆弱性スキャン**: `go list -m all | nancy sleuth`（Phase 2以降）
- **定期的な依存ライブラリ更新**: 四半期に1回

---

## 7. ユーザビリティ（API設計）

### 7.1 API設計原則
- **RESTful設計**: リソース指向、HTTPメソッドの適切な使用
- **一貫性のあるエンドポイント**: 命名規則の統一
- **適切なHTTPステータスコード**: 2xx, 4xx, 5xxの正しい使い分け
- **エラーメッセージの明確さ**: 問題と解決策を提示

### 7.2 バージョニング
- **APIバージョン**: `/api/v1/...`形式
- **後方互換性**: v1は少なくとも6ヶ月間維持
- **非推奨化プロセス**: Deprecationヘッダーで通知

### 7.3 レート制限（Phase 3）
- **認証済みユーザー**: 1000 req/hour
- **未認証**: 100 req/hour
- **レスポンスヘッダー**: X-RateLimit-*で残数通知

---

## 8. 開発環境要件

### 8.1 必須環境
| 項目 | バージョン | 備考 |
|------|-----------|------|
| Go | 1.24以上 | 最新の安定版 |
| PostgreSQL | 14以上 | ローカル開発はDockerでも可 |
| Git | 2.30以上 | バージョン管理 |

### 8.2 推奨ツール
- **IDEまたはエディタ**: VS Code, GoLand
- **API テストツール**: curl, Postman, HTTPie
- **データベースクライアント**: psql, DBeaver, TablePlus
- **Dockerとdocker-compose**: ローカル環境構築用

---

## 9. コンプライアンス・法的要件

### 9.1 データプライバシー
- **個人情報の取り扱い**: メールアドレス、名前を最小限に収集
- **データ削除権**: ユーザーアカウント削除時にデータ削除（Phase 3）
- **データエクスポート**: ユーザーが自分のデータをエクスポート可能（Phase 3）

### 9.2 ライセンス
- **アプリケーションライセンス**: MIT License（学習プロジェクトのため）
- **依存ライブラリ**: ライセンス互換性の確認（商用利用可能なライブラリのみ）

---

## 10. 非機能要件の優先順位

### Phase 1（MVP）- 必須
- ✅ 基本的なパフォーマンス（レスポンスタイム）
- ✅ JWT認証・bcryptパスワードハッシュ
- ✅ 入力検証
- ✅ 基本的なログ出力
- ✅ ヘルスチェックエンドポイント
- ✅ エラーハンドリング

### Phase 2 - 重要
- 構造化ログ（JSON形式）
- メトリクス監視（Prometheus）
- データベースバックアップ
- キャッシュ導入（Redis）
- API仕様書（OpenAPI）
- 脆弱性スキャン

### Phase 3 - あると望ましい
- レート制限
- データベース暗号化
- 水平スケーリング対応
- Blue-Greenデプロイ
- データエクスポート機能
- 高度な監視・アラート

---

## 11. 非機能要件の検証方法

### 11.1 パフォーマンステスト
- **ツール**: `vegeta`, `wrk`, `hey`
- **シナリオ**:
  - 同時50ユーザーでのタスク一覧取得
  - 100件/秒のタスク作成リクエスト
- **実施タイミング**: Phase 1完了時、各Phase完了時

### 11.2 セキュリティテスト
- **静的解析**: `gosec`
- **依存関係スキャン**: `nancy`, `govulncheck`
- **手動ペネトレーションテスト**: Phase 2以降

### 11.3 負荷テスト
- **データ投入**: 10,000タスクでのパフォーマンス確認
- **同時接続テスト**: 50ユーザー同時アクセス
- **実施タイミング**: Phase 1完了時

---

## 付録: 参考資料

### 非機能要件の設計
- [The Twelve-Factor App](https://12factor.net/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Google SRE Book](https://sre.google/books/)

### Goのベストプラクティス
- [Effective Go](https://go.dev/doc/effective_go)
- [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments)

---

**作成日**: 2026-01-06
**作成者**: 学習プロジェクト
**バージョン**: 1.0
**対象システム**: TaskFlow - プロジェクト・タスク管理システム
